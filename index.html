<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>ibonarium :: jwst slow observer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{
    width:100%;
    height:100%;
    background:#000;
    color:#cfefff;
    font-family:Inter,system-ui,monospace;
    overflow:hidden;
}

#jwst-bg{
    position:fixed;
    inset:0;
    background-size:cover;
    background-position:center;
    opacity:0;
    transition:opacity 2s ease, filter 1.5s ease;
    will-change:transform;
}

@keyframes driftSlow{
    0%{transform:scale(1)}
    100%{transform:scale(1.02)}
}

.ir{
    filter:
        brightness(0.9)
        contrast(1.25)
        saturate(1.4)
        hue-rotate(35deg);
}

#overlay{
    position:fixed;
    inset:0;
    background:radial-gradient(circle at center, rgba(0,0,0,0.25), #000 80%);
}

#controls{
    position:absolute;
    top:16px;
    left:16px;
    display:flex;
    gap:8px;
}

button{
    background:rgba(0,0,0,0.45);
    border:1px solid rgba(255,255,255,0.15);
    color:#cfefff;
    padding:6px 10px;
    border-radius:10px;
    cursor:pointer;
    font-size:13px;
}

#panel{
    position:absolute;
    bottom:16px;
    left:16px;
    background:rgba(0,0,0,0.45);
    backdrop-filter:blur(6px);
    padding:12px 16px;
    border-radius:12px;
    font-size:14px;
    line-height:1.5;
    max-width:420px;
}
</style>
</head>

<body>

<div id="jwst-bg"></div>
<div id="overlay"></div>

<div id="controls">
    <button onclick="setMode('silence')">Тиша</button>
    <button onclick="setMode('memory')">Памʼять</button>
    <button onclick="setMode('novelty')">Новизна</button>
    <button onclick="toggleIR()">IR</button>
</div>

<div id="panel">
    <b>JWST Slow Observer</b><br>
    Режим: <span id="mode"></span><br>
    <span id="meta"></span>
</div>

<script>
const CACHE_KEY = "jwst_fixed_cache";
let mode = "memory";
let ir = false;

function cacheTTL(){
    if(mode==="silence") return 72*60*60*1000;
    if(mode==="novelty") return 6*60*60*1000;
    return 24*60*60*1000;
}

async function loadJWST(){
    const cached = localStorage.getItem(CACHE_KEY);
    if(cached){
        const d = JSON.parse(cached);
        if(Date.now()-d.time < cacheTTL()){
            apply(d);
            return;
        }
    }

    /* 1️⃣ шукаємо спостереження */
    const search = await fetch("https://mast.stsci.edu/api/v0/invoke",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({
            service:"Mast.Caom.Filtered",
            params:{
                columns:"obsid,target_name,instrument_name,release_date",
                filters:[
                    {paramName:"obs_collection",values:["JWST"]},
                    {paramName:"dataproduct_type",values:["image"]},
                    {paramName:"dataRights",values:["PUBLIC"]}
                ]
            },
            format:"json",
            pagesize:1,
            page: mode==="memory" ? Math.floor(Math.random()*40)+1 : 1
        })
    });

    const obs = (await search.json()).data?.[0];
    if(!obs) return;

    /* 2️⃣ отримуємо список продуктів */
    const products = await fetch(
        `https://mast.stsci.edu/api/v0.1/Download/fileList?obsid=${obs.obsid}`
    );
    const files = await products.json();

    const jpg = files.find(f =>
        f.productFilename.endsWith(".jpg") &&
        f.productFilename.includes("i2d")
    ) || files.find(f => f.productFilename.endsWith(".jpg"));

    if(!jpg) return;

    const imgURL =
        `https://mast.stsci.edu/portal/Download/file?uri=mast:JWST/product/${jpg.productFilename}`;

    const payload = {
        img: imgURL,
        target: obs.target_name,
        instrument: obs.instrument_name,
        release: obs.release_date,
        time: Date.now()
    };

    localStorage.setItem(CACHE_KEY, JSON.stringify(payload));
    apply(payload);
}

function apply(d){
    const bg = document.getElementById("jwst-bg");
    bg.style.backgroundImage = `url(${d.img})`;
    bg.style.opacity = "1";
    bg.style.animation = "driftSlow 300s linear infinite";

    document.getElementById("mode").textContent =
        mode==="silence"?"Тиша":mode==="memory"?"Памʼять":"Новизна";

    document.getElementById("meta").innerHTML =
        `Ціль: ${d.target}<br>
         Інструмент: ${d.instrument}<br>
         Реліз: ${d.release}`;
}

function setMode(m){
    mode = m;
    localStorage.removeItem(CACHE_KEY);
    loadJWST();
}

function toggleIR(){
    ir = !ir;
    document.getElementById("jwst-bg").classList.toggle("ir", ir);
}

loadJWST();
</script>

</body>
</html>
